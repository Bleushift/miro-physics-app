<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Physics Pathway â€“ Miro Tools</title>

  <!-- KaTeX for client-side LaTeX rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>

  <!-- Miro SDK -->
  <script src="https://miro.com/app/static/sdk/v2/miro.js"></script>

  <style>
    :root {
      --black:  #1a1a2e;
      --purple: #a78bfa;
      --teal:   #5eead4;
      --yellow: #fbbf24;
      --bg:     #1e1e2e;
      --surface:#26263a;
      --border: #38385a;
      --text:   #e2e2f0;
      --muted:  #888aaa;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Tab bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tabs {
      display: flex;
      background: var(--black);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .tab {
      flex: 1;
      padding: 8px 4px;
      text-align: center;
      cursor: pointer;
      color: var(--muted);
      font-size: 11px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--purple); border-bottom-color: var(--purple); }

    /* â”€â”€ Panel pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page { display: none; flex-direction: column; flex: 1; overflow: hidden; }
    .page.active { display: flex; }

    .scroll { overflow-y: auto; flex: 1; padding: 10px; }
    .scroll::-webkit-scrollbar { width: 4px; }
    .scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* â”€â”€ Shared components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    label { display: block; color: var(--muted); font-size: 11px; margin-bottom: 4px; margin-top: 10px; text-transform: uppercase; letter-spacing: 0.05em; }
    label:first-child { margin-top: 0; }

    textarea, input[type="text"], input[type="url"] {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      resize: vertical;
      outline: none;
      transition: border-color 0.15s;
    }
    textarea:focus, input:focus { border-color: var(--purple); }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      padding: 7px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.15s;
    }
    .btn-primary  { background: var(--purple); color: #fff; }
    .btn-primary:hover  { background: #9370e8; }
    .btn-teal     { background: var(--teal);   color: var(--black); }
    .btn-teal:hover     { background: #4dd4be; }
    .btn-yellow   { background: var(--yellow); color: var(--black); }
    .btn-yellow:hover   { background: #f5a800; }
    .btn-ghost    { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-ghost:hover    { border-color: var(--purple); color: var(--purple); }
    .btn-sm { padding: 4px 8px; font-size: 11px; }
    .btn-full { width: 100%; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .row { display: flex; gap: 6px; align-items: center; }
    .row .btn { flex-shrink: 0; }
    .spacer { height: 10px; }

    /* â”€â”€ LaTeX preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #latex-preview {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      min-height: 56px;
      padding: 10px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 8px;
      overflow: auto;
    }
    #latex-preview .katex { color: #fff; }
    #latex-preview .error-msg { color: #f87171; font-size: 11px; }

    /* â”€â”€ Colour row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .colour-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    .colour-swatch {
      width: 26px; height: 26px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      flex-shrink: 0;
      transition: border-color 0.15s;
    }
    .colour-swatch.selected { border-color: #fff; }
    input[type="color"] {
      width: 26px; height: 26px;
      border: none; border-radius: 50%;
      padding: 0; cursor: pointer;
      background: none;
      flex-shrink: 0;
    }
    .text-colour-btn {
      width: 22px; height: 22px;
      border-radius: 4px;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.15s;
      border: 2px solid transparent;
    }
    .text-colour-btn:hover { border-color: #fff; transform: scale(1.15); }

    .size-label { color: var(--muted); font-size: 11px; white-space: nowrap; }
    input[type="range"] { flex: 1; accent-color: var(--purple); }

    /* â”€â”€ Edit banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #edit-banner {
      display: none;
      background: #2a1f4e;
      border: 1px solid var(--purple);
      border-radius: 6px;
      padding: 7px 10px;
      margin-bottom: 8px;
      font-size: 11px;
      color: var(--purple);
      align-items: center;
      gap: 8px;
    }
    #edit-banner.visible { display: flex; }
    #edit-banner span { flex: 1; }

    /* â”€â”€ Library search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #lib-search {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: 7px 10px;
      font-size: 12px;
      outline: none;
      margin-bottom: 8px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #lib-search:focus { border-color: var(--purple); }
    #lib-search::placeholder { color: var(--muted); }
    .lib-tag {
      display: inline-block;
      background: #2a1f4e;
      color: var(--purple);
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 3px;
      margin-left: 6px;
      font-weight: 600;
    }

    /* â”€â”€ Physics library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .lib-section { margin-bottom: 6px; }
    .lib-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 6px 8px;
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 5px;
      margin-bottom: 4px;
      user-select: none;
    }
    .lib-section-header:hover { border-color: var(--purple); }
    .lib-section-header h3 {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--purple);
      margin: 0;
    }
    .lib-section-header .toggle { color: var(--muted); font-size: 10px; transition: transform 0.2s; }
    .lib-section-header.open .toggle { transform: rotate(90deg); }
    .lib-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 3px;
      margin-bottom: 8px;
    }
    .lib-grid.collapsed { display: none; }
    .lib-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 6px 8px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .lib-item:hover { border-color: var(--teal); background: #1e2e32; }
    .lib-item .eq-name { font-size: 11px; color: var(--muted); min-width: 80px; flex-shrink: 0; }
    .lib-item .eq-katex { font-size: 16px; flex: 1; }
    .lib-item .eq-katex .katex { color: var(--teal); }

    /* â”€â”€ Embed panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .embed-type {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 10px;
    }
    .embed-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.15s;
      color: var(--text);
    }
    .embed-btn:hover { border-color: var(--teal); }
    .embed-btn.active { border-color: var(--teal); background: #1e2e32; color: var(--teal); }
    .embed-btn .icon { font-size: 18px; display: block; margin-bottom: 3px; }
    .embed-btn .name { font-size: 10px; font-weight: 600; display: block; }
    .embed-btn .note { font-size: 9px; color: var(--muted); margin-top: 1px; display: block; }

    .embed-form { display: none; }
    .embed-form.visible { display: block; }

    .info-box {
      background: #1a2e1a;
      border: 1px solid #2d5a2d;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 11px;
      color: #86efac;
      margin-top: 6px;
    }
    .warn-box {
      background: #2e1a1a;
      border: 1px solid #5a2d2d;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 11px;
      color: #fca5a5;
      margin-top: 6px;
    }

    /* â”€â”€ Status toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      white-space: nowrap;
      z-index: 999;
    }
    #toast.show { opacity: 1; }

    .geogebra-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    .ggb-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.15s;
    }
    .ggb-item:hover { border-color: var(--yellow); color: var(--yellow); }

    .phet-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    .phet-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.15s;
    }
    .phet-item:hover { border-color: var(--yellow); color: var(--yellow); }
  </style>
</head>
<body>

<!-- â”€â”€ Tab bar â”€â”€ -->
<div class="tabs">
  <div class="tab active" data-tab="latex">ğ‘“(ğ‘¥) LaTeX</div>
  <div class="tab" data-tab="library">Library</div>
  <div class="tab" data-tab="embeds">Embeds</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 1: LaTeX Editor
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-latex">
  <div class="scroll">

    <!-- Edit banner shown when an existing equation is selected -->
    <div id="edit-banner">
      <span>âœï¸ Editing selected equation</span>
      <button class="btn btn-ghost btn-sm" id="btn-cancel-edit">Cancel</button>
    </div>

    <label>LaTeX expression</label>
    <textarea id="latex-input" rows="4" placeholder="e.g. v^2 = u^2 + 2as"></textarea>

    <label style="margin-top:8px">Colour selected text <span style="color:var(--muted);font-size:10px">(select text above, then click)</span></label>
    <div class="colour-row" id="text-colour-row">
      <div class="text-colour-btn" style="background:#f87171" data-tc="#f87171" title="Red"></div>
      <div class="text-colour-btn" style="background:#93c5fd" data-tc="#3b82f6" title="Blue"></div>
      <div class="text-colour-btn" style="background:#86efac" data-tc="#22c55e" title="Green"></div>
      <div class="text-colour-btn" style="background:#a78bfa" data-tc="#a78bfa" title="Purple"></div>
      <div class="text-colour-btn" style="background:#fbbf24" data-tc="#fbbf24" title="Yellow"></div>
      <div class="text-colour-btn" style="background:#5eead4" data-tc="#5eead4" title="Teal"></div>
      <div class="text-colour-btn" style="background:#f9a8d4" data-tc="#ec4899" title="Pink"></div>
      <div class="text-colour-btn" style="background:#ffffff; border:1px solid var(--border)" data-tc="#ffffff" title="White"></div>
      <button class="btn btn-ghost btn-sm" id="btn-remove-colour" title="Remove colour from selection" style="font-size:10px;padding:3px 6px;">âœ•</button>
    </div>

    <div id="latex-preview">
      <span style="color:var(--muted); font-size:11px">Preview will appear here</span>
    </div>

    <label style="margin-top:12px">Whole equation colour</label>
    <div class="colour-row">
      <div class="colour-swatch selected" style="background:#ffffff" data-colour="#ffffff" title="White"></div>
      <div class="colour-swatch" style="background:#a78bfa" data-colour="#a78bfa" title="Purple"></div>
      <div class="colour-swatch" style="background:#5eead4" data-colour="#5eead4" title="Teal"></div>
      <div class="colour-swatch" style="background:#fbbf24" data-colour="#fbbf24" title="Yellow"></div>
      <div class="colour-swatch" style="background:#f87171" data-colour="#f87171" title="Red"></div>
      <div class="colour-swatch" style="background:#86efac" data-colour="#86efac" title="Green"></div>
      <div class="colour-swatch" style="background:#93c5fd" data-colour="#93c5fd" title="Blue"></div>
      <input type="color" id="custom-colour" value="#ffffff" title="Custom colour" />
    </div>

    <label style="margin-top:10px">Size <span id="size-val" style="color:var(--text)">36px</span></label>
    <div class="row">
      <span class="size-label">S</span>
      <input type="range" id="font-size" min="16" max="96" value="36" step="4" />
      <span class="size-label">XL</span>
    </div>

    <div class="spacer"></div>
    <div class="row">
      <button class="btn btn-primary btn-full" id="btn-place">Place on board</button>
      <button class="btn btn-ghost" id="btn-place-update" style="display:none">Update</button>
    </div>

    <div class="spacer"></div>
    <label>Selection</label>
    <button class="btn btn-ghost btn-full" id="btn-load-selection">â†‘ Load selected equation for editing</button>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 2: Physics Library
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-library">
  <div class="scroll" id="library-scroll">
    <input type="text" id="lib-search" placeholder="Search equations... (e.g. SUVAT, capacitor, Snell)" />
    <div id="lib-sections"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 3: Embeds
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-embeds">
  <div class="scroll">

    <label>Tool</label>
    <div class="embed-type">
      <div class="embed-btn active" data-embed="youtube">
        <span class="icon">â–¶</span>
        <span class="name">YouTube</span>
        <span class="note">Native embed</span>
      </div>
      <div class="embed-btn" data-embed="geogebra">
        <span class="icon">ğŸ“</span>
        <span class="name">GeoGebra</span>
        <span class="note">Interactive</span>
      </div>
      <div class="embed-btn" data-embed="phet">
        <span class="icon">âš›</span>
        <span class="name">PhET Sim</span>
        <span class="note">Interactive</span>
      </div>
      <div class="embed-btn" data-embed="isaac">
        <span class="icon">ğŸ”¬</span>
        <span class="name">Isaac Physics</span>
        <span class="note">Opens tab</span>
      </div>
    </div>

    <!-- YouTube -->
    <div class="embed-form visible" id="form-youtube">
      <label>YouTube URL or video ID</label>
      <input type="url" id="yt-url" placeholder="https://youtube.com/watch?v=dQw4w9WgXcQ" />
      <div class="info-box">Placed as a live, playable video card directly on your Miro board.</div>
      <div class="spacer"></div>
      <button class="btn btn-teal btn-full" id="btn-yt-embed">Embed video on board</button>
    </div>

    <!-- GeoGebra -->
    <div class="embed-form" id="form-geogebra">
      <label>Physics applets (click to embed)</label>
      <div class="geogebra-grid" id="ggb-list">
        <!-- Populated by JS -->
      </div>
      <div class="spacer"></div>
      <label>Or paste a GeoGebra URL / material ID</label>
      <input type="text" id="ggb-id" placeholder="e.g. https://www.geogebra.org/m/abcdef12 or abcdef12" />
      <div class="info-box">Embedded as an interactive applet on your board. Students can manipulate it live.</div>
      <div class="spacer"></div>
      <button class="btn btn-teal btn-full" id="btn-ggb-embed">Embed applet on board</button>
    </div>

    <!-- PhET -->
    <div class="embed-form" id="form-phet">
      <label>Physics simulations (click to embed)</label>
      <div class="phet-grid" id="phet-list">
        <!-- Populated by JS -->
      </div>
      <div class="spacer"></div>
      <label>Or paste a PhET sim name</label>
      <input type="text" id="phet-slug" placeholder="e.g. projectile-motion" />
      <div class="info-box">Embedded as a fully interactive simulation on your board.</div>
      <div class="spacer"></div>
      <button class="btn btn-teal btn-full" id="btn-phet-embed">Embed simulation on board</button>
    </div>

    <!-- Isaac Physics -->
    <div class="embed-form" id="form-isaac">
      <label>Isaac Physics question / concept</label>
      <input type="url" id="isaac-url" placeholder="https://isaacphysics.org/questions/..." />
      <div class="warn-box">
        Isaac Physics blocks embedding in other sites. Clicking below places a <strong>clickable card</strong> on your board â€” students click it to open Isaac in a new tab.
      </div>
      <div class="spacer"></div>
      <label>Card label (optional)</label>
      <input type="text" id="isaac-label" placeholder="e.g. Projectile motion â€“ Q3" />
      <div class="spacer"></div>
      <button class="btn btn-yellow btn-full" id="btn-isaac-card">Place Isaac Physics card</button>
    </div>

  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PHYSICS_LIBRARY = [
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FUNDAMENTAL CONSTANTS & VALUES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Fundamental Constants',
    equations: [
      { name: 'speed of light',                latex: 'c = 3.00 \\times 10^8\\;\\text{m s}^{-1}' },
      { name: 'permittivity of free space',    latex: '\\varepsilon_0 = 8.85 \\times 10^{-12}\\;\\text{F m}^{-1}' },
      { name: 'Coulomb constant',              latex: '\\dfrac{1}{4\\pi\\varepsilon_0} = 8.99 \\times 10^9\\;\\text{N m}^2\\text{ C}^{-2}' },
      { name: 'electron charge',               latex: 'e = 1.60 \\times 10^{-19}\\;\\text{C}' },
      { name: 'Planck constant',               latex: 'h = 6.63 \\times 10^{-34}\\;\\text{J s}' },
      { name: 'gravitational constant',        latex: 'G = 6.67 \\times 10^{-11}\\;\\text{N m}^2\\text{ kg}^{-2}' },
      { name: 'Avogadro constant',             latex: 'N_A = 6.02 \\times 10^{23}\\;\\text{mol}^{-1}' },
      { name: 'molar gas constant',            latex: 'R = 8.31\\;\\text{J mol}^{-1}\\text{ K}^{-1}' },
      { name: 'Boltzmann constant',            latex: 'k = 1.38 \\times 10^{-23}\\;\\text{J K}^{-1}' },
      { name: 'Stefan constant',               latex: '\\sigma = 5.67 \\times 10^{-8}\\;\\text{W m}^{-2}\\text{ K}^{-4}' },
      { name: 'permeability of free space',    latex: '\\mu_0 = 4\\pi \\times 10^{-7}\\;\\text{H m}^{-1}' },
      { name: 'electron mass',                 latex: 'm_e = 9.11 \\times 10^{-31}\\;\\text{kg}' },
      { name: 'proton mass',                   latex: 'm_p = 1.67(3) \\times 10^{-27}\\;\\text{kg}' },
      { name: 'neutron mass',                  latex: 'm_n = 1.67(5) \\times 10^{-27}\\;\\text{kg}' },
      { name: 'atomic mass unit',              latex: 'u = 1.661 \\times 10^{-27}\\;\\text{kg} = 931.5\\;\\text{MeV}' },
      { name: 'g on Earth',                    latex: 'g = 9.81\\;\\text{m s}^{-2}' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3.2 PARTICLES & RADIATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Photons & Energy Levels',
    equations: [
      { name: 'photon energy',               latex: 'E = hf' },
      { name: 'photon energy (wavelength)',   latex: 'E = \\dfrac{hc}{\\lambda}' },
      { name: 'photoelectric equation',       latex: 'hf = \\phi + E_{k(\\max)}' },
      { name: 'de Broglie wavelength',        latex: '\\lambda = \\dfrac{h}{mv}' },
      { name: 'energy level transition',      latex: 'hf = E_1 - E_2' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3.3 WAVES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Progressive Waves',
    equations: [
      { name: 'wave speed',           latex: 'v = f\\lambda' },
      { name: 'period',               latex: 'f = \\dfrac{1}{T}' },
      { name: 'intensity',            latex: 'I = \\dfrac{P}{A}' },
    ]
  },
  {
    section: 'Refraction',
    equations: [
      { name: 'refractive index',        latex: 'n = \\dfrac{c}{v}' },
      { name: "Snell's law",             latex: 'n_1 \\sin\\theta_1 = n_2 \\sin\\theta_2' },
      { name: 'critical angle',          latex: '\\sin\\theta_c = \\dfrac{n_2}{n_1}' },
    ]
  },
  {
    section: 'Interference & Diffraction',
    equations: [
      { name: 'diffraction grating',     latex: 'd\\sin\\theta = n\\lambda' },
      { name: 'double slit',             latex: 'w = \\dfrac{\\lambda D}{s}' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3.4 MECHANICS & MATERIALS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Kinematics (SUVAT)',
    equations: [
      { name: 'v = u + at',             latex: 'v = u + at' },
      { name: 'vÂ² = uÂ² + 2as',          latex: 'v^2 = u^2 + 2as' },
      { name: 's = ut + Â½atÂ²',          latex: 's = ut + \\tfrac{1}{2}at^2' },
      { name: 's = Â½(u+v)t',            latex: 's = \\tfrac{1}{2}(u + v)t' },
      { name: 's = vt âˆ’ Â½atÂ²',          latex: 's = vt - \\tfrac{1}{2}at^2' },
    ]
  },
  {
    section: 'Forces & Momentum',
    equations: [
      { name: 'force (Newton II)',       latex: 'F = ma' },
      { name: 'weight',                  latex: 'W = mg' },
      { name: 'momentum',                latex: 'p = mv' },
      { name: 'impulse',                 latex: 'F\\,\\Delta t = \\Delta(mv)' },
      { name: 'moment',                  latex: '\\text{moment} = Fd' },
    ]
  },
  {
    section: 'Energy & Power',
    equations: [
      { name: 'work done',              latex: 'W = Fs\\cos\\theta' },
      { name: 'kinetic energy',          latex: 'E_k = \\tfrac{1}{2}mv^2' },
      { name: 'gravitational PE',       latex: '\\Delta E_p = mg\\Delta h' },
      { name: 'power',                   latex: 'P = \\dfrac{\\Delta W}{\\Delta t}' },
      { name: 'power (force Ã— velocity)',latex: 'P = Fv' },
      { name: 'efficiency',              latex: '\\text{efficiency} = \\dfrac{\\text{useful output}}{\\text{total input}}' },
    ]
  },
  {
    section: 'Materials',
    equations: [
      { name: 'density',                 latex: '\\rho = \\dfrac{m}{V}' },
      { name: 'Hooke\'s law',            latex: 'F = k\\,\\Delta L' },
      { name: 'Young modulus',            latex: 'E = \\dfrac{\\sigma}{\\varepsilon} = \\dfrac{FL}{A\\,\\Delta L}' },
      { name: 'stress',                  latex: '\\sigma = \\dfrac{F}{A}' },
      { name: 'strain',                  latex: '\\varepsilon = \\dfrac{\\Delta L}{L}' },
      { name: 'elastic strain energy',   latex: 'E = \\tfrac{1}{2}F\\,\\Delta L = \\tfrac{1}{2}k\\,(\\Delta L)^2' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3.5 ELECTRICITY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Current & Charge',
    equations: [
      { name: 'charge',                  latex: '\\Delta Q = I\\,\\Delta t' },
      { name: 'potential difference',    latex: 'V = \\dfrac{W}{Q}' },
      { name: 'Ohm\'s law',              latex: 'V = IR' },
      { name: 'resistivity',             latex: 'R = \\dfrac{\\rho L}{A}' },
    ]
  },
  {
    section: 'Power & Energy',
    equations: [
      { name: 'electrical power',        latex: 'P = IV = I^2 R = \\dfrac{V^2}{R}' },
      { name: 'energy transferred',      latex: 'W = VIt' },
      { name: 'EMF equation',            latex: '\\varepsilon = I(R + r)' },
      { name: 'terminal PD',             latex: '\\varepsilon = V + Ir' },
    ]
  },
  {
    section: 'Circuit Rules',
    equations: [
      { name: 'resistors in series',     latex: 'R_T = R_1 + R_2 + R_3 + \\cdots' },
      { name: 'resistors in parallel',   latex: '\\dfrac{1}{R_T} = \\dfrac{1}{R_1} + \\dfrac{1}{R_2} + \\dfrac{1}{R_3} + \\cdots' },
      { name: 'potential divider',       latex: 'V_{\\text{out}} = \\dfrac{R_2}{R_1 + R_2}\\,V_{\\text{in}}' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3.6 FURTHER MECHANICS & THERMAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Circular Motion',
    equations: [
      { name: 'angular speed',           latex: '\\omega = \\dfrac{2\\pi}{T} = 2\\pi f' },
      { name: 'linear speed',            latex: 'v = \\omega r' },
      { name: 'centripetal acceleration', latex: 'a = \\dfrac{v^2}{r} = \\omega^2 r' },
      { name: 'centripetal force',        latex: 'F = \\dfrac{mv^2}{r} = m\\omega^2 r' },
    ]
  },
  {
    section: 'Simple Harmonic Motion',
    equations: [
      { name: 'SHM condition',           latex: 'a = -\\omega^2 x' },
      { name: 'displacement',            latex: 'x = A\\cos(\\omega t)' },
      { name: 'velocity (max)',          latex: 'v_{\\max} = \\omega A' },
      { name: 'velocity',                latex: 'v = \\pm\\omega\\sqrt{A^2 - x^2}' },
      { name: 'period (massâ€“spring)',    latex: 'T = 2\\pi\\sqrt{\\dfrac{m}{k}}' },
      { name: 'period (pendulum)',       latex: 'T = 2\\pi\\sqrt{\\dfrac{l}{g}}' },
    ]
  },
  {
    section: 'Thermal Physics',
    equations: [
      { name: 'internal energy',          latex: '\\Delta U = Q - W' },
      { name: 'specific heat capacity',  latex: 'Q = mc\\,\\Delta\\theta' },
      { name: 'specific latent heat',    latex: 'Q = mL' },
      { name: 'ideal gas law',            latex: 'pV = nRT' },
      { name: 'ideal gas (Boltzmann)',   latex: 'pV = NkT' },
      { name: 'kinetic theory',          latex: '\\tfrac{1}{2}m\\langle c^2\\rangle = \\tfrac{3}{2}kT' },
      { name: 'gas pressure',            latex: 'pV = \\tfrac{1}{3}Nm\\langle c^2\\rangle' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3.7 FIELDS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Gravitational Fields',
    equations: [
      { name: 'Newton\'s law of gravitation', latex: 'F = \\dfrac{Gm_1 m_2}{r^2}' },
      { name: 'gravitational field strength', latex: 'g = \\dfrac{F}{m} = \\dfrac{GM}{r^2}' },
      { name: 'gravitational potential',      latex: 'V = -\\dfrac{GM}{r}' },
      { name: 'orbital speed',                latex: 'v = \\sqrt{\\dfrac{GM}{r}}' },
      { name: 'orbital period',               latex: 'T^2 = \\dfrac{4\\pi^2 r^3}{GM}' },
      { name: 'escape velocity',              latex: 'v_{\\text{esc}} = \\sqrt{\\dfrac{2GM}{r}}' },
    ]
  },
  {
    section: 'Electric Fields',
    equations: [
      { name: 'Coulomb\'s law',               latex: 'F = \\dfrac{1}{4\\pi\\varepsilon_0}\\dfrac{Q_1 Q_2}{r^2}' },
      { name: 'electric field strength (radial)', latex: 'E = \\dfrac{1}{4\\pi\\varepsilon_0}\\dfrac{Q}{r^2}' },
      { name: 'electric field strength (uniform)', latex: 'E = \\dfrac{V}{d}' },
      { name: 'field strength',               latex: 'E = \\dfrac{F}{Q}' },
      { name: 'electric potential',            latex: 'V = \\dfrac{1}{4\\pi\\varepsilon_0}\\dfrac{Q}{r}' },
      { name: 'work done (field)',             latex: 'W = QV' },
    ]
  },
  {
    section: 'Capacitance',
    equations: [
      { name: 'capacitance',                  latex: 'C = \\dfrac{Q}{V}' },
      { name: 'parallel plate capacitor',     latex: 'C = \\dfrac{\\varepsilon_0 \\varepsilon_r A}{d}' },
      { name: 'energy stored',                latex: 'E = \\tfrac{1}{2}QV = \\tfrac{1}{2}CV^2 = \\dfrac{Q^2}{2C}' },
      { name: 'capacitors in parallel',       latex: 'C_T = C_1 + C_2 + C_3' },
      { name: 'capacitors in series',         latex: '\\dfrac{1}{C_T} = \\dfrac{1}{C_1} + \\dfrac{1}{C_2} + \\dfrac{1}{C_3}' },
      { name: 'charging/discharging',         latex: 'Q = Q_0\\,e^{-t/RC}' },
      { name: 'time constant',                latex: '\\tau = RC' },
    ]
  },
  {
    section: 'Magnetic Fields',
    equations: [
      { name: 'force on wire',                latex: 'F = BIl\\sin\\theta' },
      { name: 'force on charge',              latex: 'F = BQv\\sin\\theta' },
      { name: 'magnetic flux',                latex: '\\Phi = BA\\cos\\theta' },
      { name: 'flux linkage',                 latex: 'N\\Phi = BAN\\cos\\theta' },
      { name: 'Faraday\'s law',               latex: '\\varepsilon = -N\\dfrac{\\Delta\\Phi}{\\Delta t}' },
      { name: 'transformer ratio',            latex: '\\dfrac{V_s}{V_p} = \\dfrac{N_s}{N_p}' },
      { name: 'alternating current',          latex: 'I_{\\text{rms}} = \\dfrac{I_0}{\\sqrt{2}},\\quad V_{\\text{rms}} = \\dfrac{V_0}{\\sqrt{2}}' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3.8 NUCLEAR PHYSICS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Nuclear Physics',
    equations: [
      { name: 'massâ€“energy equivalence',      latex: 'E = mc^2' },
      { name: 'massâ€“energy (amu)',            latex: '\\Delta E = \\Delta m\\,c^2' },
      { name: 'activity',                     latex: 'A = \\lambda N' },
      { name: 'decay law',                    latex: 'N = N_0\\,e^{-\\lambda t}' },
      { name: 'half-life',                    latex: 't_{\\frac{1}{2}} = \\dfrac{\\ln 2}{\\lambda}' },
      { name: 'nuclear radius',               latex: 'R = R_0\\,A^{1/3}' },
      { name: 'inverse square law (gamma)',   latex: 'I = \\dfrac{k}{x^2}' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OPTION A â€” ASTROPHYSICS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Astrophysics',
    equations: [
      { name: 'lens equation',                latex: '\\dfrac{1}{u} + \\dfrac{1}{v} = \\dfrac{1}{f}' },
      { name: 'magnification (telescope)',    latex: 'M = \\dfrac{f_o}{f_e}' },
      { name: 'resolving power (Rayleigh)',   latex: '\\theta \\approx \\dfrac{\\lambda}{D}' },
      { name: 'Stefan\'s law',                latex: 'P = \\sigma A T^4' },
      { name: 'Wien\'s law',                  latex: '\\lambda_{\\max} T = 2.898 \\times 10^{-3}\\;\\text{m K}' },
      { name: 'luminosityâ€“intensity',         latex: 'I = \\dfrac{L}{4\\pi d^2}' },
      { name: 'Doppler (red/blue shift)',     latex: '\\dfrac{\\Delta\\lambda}{\\lambda} = \\dfrac{\\Delta f}{f} \\approx \\dfrac{v}{c}' },
      { name: 'Hubble\'s law',                latex: 'v = H_0\\,d' },
      { name: 'cosmological red shift',       latex: '\\dfrac{\\Delta\\lambda}{\\lambda} \\approx \\dfrac{v}{c}' },
      { name: 'standard candle ratio',        latex: '\\dfrac{d_1}{d_2} = \\sqrt{\\dfrac{I_2}{I_1}}' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OPTION B â€” MEDICAL PHYSICS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Medical Physics',
    equations: [
      { name: 'X-ray attenuation',            latex: 'I = I_0\\,e^{-\\mu x}' },
      { name: 'half-value thickness',         latex: '\\mu = \\dfrac{\\ln 2}{x_{1/2}}' },
      { name: 'acoustic impedance',           latex: 'Z = \\rho c' },
      { name: 'reflection coefficient',       latex: '\\dfrac{I_r}{I_0} = \\left(\\dfrac{Z_2 - Z_1}{Z_2 + Z_1}\\right)^2' },
      { name: 'Doppler ultrasound',            latex: '\\Delta f = \\dfrac{2f_0\\,v\\cos\\theta}{c}' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OPTION D â€” TURNING POINTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Turning Points',
    equations: [
      { name: 'specific charge (e/m)',        latex: '\\dfrac{e}{m} = \\dfrac{2V}{B^2 r^2}' },
      { name: 'Millikan\'s oil drop',         latex: 'QE = mg - U' },
      { name: 'electron in E and B fields',   latex: 'v = \\dfrac{E}{B}' },
      { name: 'Bragg diffraction',            latex: 'n\\lambda = 2d\\sin\\theta' },
    ]
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OPTION E â€” ELECTRONICS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    section: 'Electronics',
    equations: [
      { name: 'inverting amplifier',          latex: 'V_{\\text{out}} = -\\dfrac{R_f}{R_{\\text{in}}}\\,V_{\\text{in}}' },
      { name: 'non-inverting amplifier',      latex: 'V_{\\text{out}} = \\left(1 + \\dfrac{R_f}{R_{\\text{in}}}\\right)V_{\\text{in}}' },
      { name: 'gain (dB)',                     latex: 'G = 10\\log\\dfrac{P_{\\text{out}}}{P_{\\text{in}}}' },
      { name: 'bandwidth Ã— gain',             latex: 'f_{3\\text{dB}} \\times A = \\text{const}' },
    ]
  },
];

const GEOGEBRA_APPLETS = [
  { name: 'Projectile motion',      id: 'xyzvwxyz' },  // example IDs â€“ user replaces with real ones
  { name: 'Simple harmonic motion', id: 'uyxzmrms' },
  { name: 'Electric field lines',   id: 'nfkbrwdy' },
  { name: 'Refraction (Snell)',      id: 'sxzxmkyc' },
  { name: 'Circular motion',        id: 'kpfpkqme' },
  { name: 'Capacitor charge',       id: 'mxbkpvzj' },
  { name: 'Wave superposition',     id: 'tdkwxwxd' },
  { name: 'Magnetic field',         id: 'qknfmtqs' },
];

const PHET_SIMS = [
  { name: 'Projectile Motion',      slug: 'projectile-motion' },
  { name: 'Wave on a String',       slug: 'wave-on-a-string' },
  { name: 'Circuit Construction',   slug: 'circuit-construction-kit-dc' },
  { name: 'Gravity & Orbits',       slug: 'gravity-and-orbits' },
  { name: 'Charges & Fields',       slug: 'charges-and-fields' },
  { name: 'Energy Skate Park',      slug: 'energy-skate-park' },
  { name: 'Wave Interference',      slug: 'wave-interference' },
  { name: 'Quantum Tunnelling',     slug: 'quantum-tunneling' },
  { name: 'Nuclear Fission',        slug: 'nuclear-fission' },
  { name: 'Bending Light',          slug: 'bending-light' },
  { name: 'Faraday Law',            slug: 'faradays-law' },
  { name: 'Gas Properties',         slug: 'gas-properties' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let selectedColour = '#ffffff';
let editingItemId  = null;   // Miro item ID of equation being edited

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toast(msg, ms = 2200) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), ms);
}

function getLatex() {
  return document.getElementById('latex-input').value.trim();
}

function getFontSize() {
  return parseInt(document.getElementById('font-size').value);
}

/** Render LaTeX to an SVG data-URL using KaTeX, coloured appropriately */
function latexToSvgUrl(latex, colour, size) {
  try {
    const svg = katex.renderToString(latex, {
      throwOnError: true,
      output: 'svg',
      displayMode: true,
    });
    // SVG from KaTeX has no explicit colour â€” inject it via style on the root
    const coloured = svg.replace('<svg', `<svg style="color:${colour};fill:${colour}"`);
    const blob = new Blob([coloured], { type: 'image/svg+xml' });
    return URL.createObjectURL(blob);
  } catch(e) {
    return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let previewTimer = null;

function updatePreview() {
  const latex   = getLatex();
  const preview = document.getElementById('latex-preview');
  if (!latex) {
    preview.innerHTML = '<span style="color:var(--muted);font-size:11px">Preview will appear here</span>';
    return;
  }
  try {
    const html = katex.renderToString(latex, { throwOnError: true, displayMode: true });
    // Apply selected colour via filter / SVG colour trick isn't needed for DOM rendering
    preview.innerHTML = `<div style="color:${selectedColour}">${html}</div>`;
  } catch(e) {
    preview.innerHTML = `<span class="error-msg">âš  ${e.message}</span>`;
  }
}

document.getElementById('latex-input').addEventListener('input', () => {
  clearTimeout(previewTimer);
  previewTimer = setTimeout(updatePreview, 200);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLOUR PICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.querySelectorAll('.colour-swatch').forEach(swatch => {
  swatch.addEventListener('click', () => {
    document.querySelectorAll('.colour-swatch').forEach(s => s.classList.remove('selected'));
    swatch.classList.add('selected');
    selectedColour = swatch.dataset.colour;
    document.getElementById('custom-colour').value = selectedColour;
    updatePreview();
  });
});

document.getElementById('custom-colour').addEventListener('input', e => {
  selectedColour = e.target.value;
  document.querySelectorAll('.colour-swatch').forEach(s => s.classList.remove('selected'));
  updatePreview();
});

// Font size display
document.getElementById('font-size').addEventListener('input', e => {
  document.getElementById('size-val').textContent = e.target.value + 'px';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXT COLOUR (wrap selected text in \textcolor)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.querySelectorAll('.text-colour-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const input = document.getElementById('latex-input');
    const start = input.selectionStart;
    const end = input.selectionEnd;
    if (start === end) { toast('Select some text first'); return; }

    const before = input.value.substring(0, start);
    const selected = input.value.substring(start, end);
    const after = input.value.substring(end);
    const colour = btn.dataset.tc;

    input.value = before + `\\textcolor{${colour}}{${selected}}` + after;
    // Place cursor after the inserted text
    const newPos = before.length + `\\textcolor{${colour}}{${selected}}`.length;
    input.setSelectionRange(newPos, newPos);
    input.focus();
    updatePreview();
  });
});

document.getElementById('btn-remove-colour').addEventListener('click', () => {
  const input = document.getElementById('latex-input');
  // Remove \textcolor{...}{...} wrappers â€” unwrap to just the inner content
  input.value = input.value.replace(/\\textcolor\{[^}]*\}\{([^}]*)\}/g, '$1');
  input.focus();
  updatePreview();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('page-' + tab.dataset.tab).classList.add('active');
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIRO SDK INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function placeSvgOnBoard(svgString, latex, colour, existingId = null, existingX = null, existingY = null) {
  // Convert SVG to base64 data URL (Miro doesn't accept blob: URLs)
  const b64 = btoa(unescape(encodeURIComponent(svgString)));
  const dataUrl = `data:image/svg+xml;base64,${b64}`;

  let x = 0, y = 0;
  if (existingX !== null) { x = existingX; y = existingY; }
  else {
    // Place in centre of current viewport
    const viewport = await miro.board.viewport.get();
    x = viewport.x + 0.5 * viewport.width;
    y = viewport.y + 0.5 * viewport.height;
  }

  // Delete existing if updating
  if (existingId) {
    try {
      await miro.board.remove(await miro.board.getById(existingId));
    } catch(e) {}
  }

  // Create image from base64 data URL
  const img = await miro.board.createImage({
    url: dataUrl,
    title: 'LaTeX equation',
    x, y,
    width: getFontSize() * 6,
  });

  // Attach LaTeX metadata so we can edit it later
  await img.setMetadata('pp-latex', { latex, colour });

  await miro.board.viewport.zoomTo(img);
  toast('Equation placed âœ“');
  return img;
}

function buildSvg(latex, colour, size) {
  try {
    const rawSvg = katex.renderToString(latex, {
      throwOnError: true,
      output: 'svg',
      displayMode: true,
    });
    // Inject colour
    return rawSvg.replace('<svg', `<svg style="color:${colour};fill:${colour}" width="${size * 5}" height="${size * 2}"`);
  } catch(e) {
    return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLACE / UPDATE BUTTON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function handlePlace(updating = false) {
  const latex = getLatex();
  if (!latex) { toast('Enter a LaTeX expression first'); return; }

  const size = getFontSize();
  const svg  = buildSvg(latex, selectedColour, size);
  if (!svg) { toast('LaTeX error â€“ check your expression'); return; }

  const btn = document.getElementById(updating ? 'btn-place-update' : 'btn-place');
  btn.disabled = true;
  btn.textContent = updating ? 'Updatingâ€¦' : 'Placingâ€¦';

  try {
    if (updating && editingItemId) {
      // Get current position of the item we're replacing
      const old = await miro.board.getById(editingItemId);
      await placeSvgOnBoard(svg, latex, selectedColour, editingItemId, old.x, old.y);
      cancelEdit();
    } else {
      await placeSvgOnBoard(svg, latex, selectedColour);
    }
  } catch(e) {
    toast('Error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = updating ? 'Update' : 'Place on board';
  }
}

document.getElementById('btn-place').addEventListener('click', () => handlePlace(false));
document.getElementById('btn-place-update').addEventListener('click', () => handlePlace(true));

// Cmd+Enter (Mac) or Ctrl+Enter (Windows) to place/update
// Cmd+Shift+A â€” toggle aligned environment (align by =)
document.getElementById('latex-input').addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
    e.preventDefault();
    handlePlace(!!editingItemId);
    return;
  }

  if ((e.metaKey || e.ctrlKey) && e.shiftKey && (e.key === 'a' || e.key === 'A')) {
    e.preventDefault();
    toggleAligned();
    return;
  }
});

function toggleAligned() {
  const input = document.getElementById('latex-input');
  let val = input.value.trim();

  // If already aligned, unwrap
  if (val.includes('\\begin{aligned}')) {
    val = val
      .replace(/\\begin\{aligned\}\s*/g, '')
      .replace(/\s*\\end\{aligned\}/g, '')
      .replace(/\s*&=/g, ' =')
      .replace(/\s*\\\\\s*/g, '\n');
    input.value = val;
    updatePreview();
    toast('Alignment removed');
    return;
  }

  // Split on newlines or \\
  let lines = val.split(/\n|\\\\/).map(l => l.trim()).filter(l => l.length > 0);

  if (lines.length < 2) {
    toast('Type multiple lines first (one equation per line)');
    return;
  }

  // Insert & before each = (but not &= which is already done, and not \= or <=, >=, !=)
  lines = lines.map(line => {
    // Only add & before the first standalone = in each line
    return line.replace(/(?<!&)(?<!\\)(?<![<>!])=/, '&=');
  });

  input.value = `\\begin{aligned}\n${lines.join(' \\\\\\\\\n')}\n\\end{aligned}`;
  updatePreview();
  toast('Aligned by = âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD SELECTION FOR EDITING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('btn-load-selection').addEventListener('click', async () => {
  try {
    const sel = await miro.board.getSelection();
    if (!sel || sel.length === 0) { toast('Select an equation on the board first'); return; }

    const item = sel[0];
    const allMeta = await item.getMetadata('pp-latex');

    if (!allMeta || !allMeta.latex) {
      toast('Selected item has no stored LaTeX â€” it may not have been placed by this plugin');
      return;
    }

    // Load into editor
    document.getElementById('latex-input').value = allMeta.latex;
    if (allMeta.colour) {
      selectedColour = allMeta.colour;
      document.getElementById('custom-colour').value = allMeta.colour;
      document.querySelectorAll('.colour-swatch').forEach(s => s.classList.remove('selected'));
    }
    editingItemId = item.id;

    // Show edit UI
    document.getElementById('edit-banner').classList.add('visible');
    document.getElementById('btn-place').style.display = 'none';
    document.getElementById('btn-place-update').style.display = '';

    updatePreview();
    toast('Loaded â€” edit and click Update');
  } catch(e) {
    toast('Error loading selection: ' + e.message);
  }
});

function cancelEdit() {
  editingItemId = null;
  document.getElementById('edit-banner').classList.remove('visible');
  document.getElementById('btn-place').style.display = '';
  document.getElementById('btn-place-update').style.display = 'none';
}

document.getElementById('btn-cancel-edit').addEventListener('click', cancelEdit);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIBRARY PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildLibrary() {
  const container = document.getElementById('lib-sections');
  container.innerHTML = '';

  PHYSICS_LIBRARY.forEach((section, idx) => {
    const div = document.createElement('div');
    div.className = 'lib-section';

    // Collapsible header
    const header = document.createElement('div');
    header.className = 'lib-section-header';
    header.innerHTML = `<h3>${section.section} <span class="lib-tag">${section.equations.length}</span></h3><span class="toggle">â–¶</span>`;
    header.addEventListener('click', () => {
      header.classList.toggle('open');
      grid.classList.toggle('collapsed');
    });

    // Grid of equations (collapsed by default except first)
    const grid = document.createElement('div');
    grid.className = 'lib-grid' + (idx > 0 ? ' collapsed' : '');
    if (idx === 0) header.classList.add('open');

    section.equations.forEach(eq => {
      const item = document.createElement('div');
      item.className = 'lib-item';
      item.title = 'Click to load in editor';
      item.dataset.search = (eq.name + ' ' + section.section).toLowerCase();

      let rendered = '';
      try {
        rendered = katex.renderToString(eq.latex, { throwOnError: false, displayMode: false });
      } catch(e) { rendered = eq.name; }

      item.innerHTML = `<div class="eq-name">${eq.name}</div><div class="eq-katex">${rendered}</div>`;
      item.addEventListener('click', () => {
        document.getElementById('latex-input').value = eq.latex;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelector('[data-tab="latex"]').classList.add('active');
        document.getElementById('page-latex').classList.add('active');
        updatePreview();
        toast('Loaded: ' + eq.name);
      });
      grid.appendChild(item);
    });

    div.appendChild(header);
    div.appendChild(grid);
    container.appendChild(div);
  });

  // Search
  document.getElementById('lib-search').addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase().trim();
    container.querySelectorAll('.lib-section').forEach(sec => {
      const items = sec.querySelectorAll('.lib-item');
      const grid = sec.querySelector('.lib-grid');
      const header = sec.querySelector('.lib-section-header');
      let anyVisible = false;
      items.forEach(item => {
        const match = !q || item.dataset.search.includes(q);
        item.style.display = match ? '' : 'none';
        if (match) anyVisible = true;
      });
      sec.style.display = anyVisible ? '' : 'none';
      // Auto-expand matching sections during search
      if (q && anyVisible) {
        grid.classList.remove('collapsed');
        header.classList.add('open');
      }
      if (!q) {
        // Collapse all except first on clear
        const isFirst = sec === container.firstElementChild;
        if (!isFirst) { grid.classList.add('collapsed'); header.classList.remove('open'); }
        else { grid.classList.remove('collapsed'); header.classList.add('open'); }
      }
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMBED BUTTONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.querySelectorAll('.embed-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.embed-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.embed-form').forEach(f => f.classList.remove('visible'));
    btn.classList.add('active');
    document.getElementById('form-' + btn.dataset.embed).classList.add('visible');
  });
});

// â”€â”€ YouTube â”€â”€
document.getElementById('btn-yt-embed').addEventListener('click', async () => {
  let url = document.getElementById('yt-url').value.trim();
  if (!url) { toast('Enter a YouTube URL'); return; }

  // Extract video ID from various URL forms
  let videoId = url;
  const match = url.match(/(?:v=|youtu\.be\/|embed\/)([a-zA-Z0-9_-]{11})/);
  if (match) videoId = match[1];

  const embedUrl = `https://www.youtube.com/embed/${videoId}`;
  try {
    await miro.board.createEmbed({ url: embedUrl, width: 640, height: 360 });
    toast('Video embedded âœ“');
  } catch(e) {
    toast('Error: ' + e.message);
  }
});

// â”€â”€ GeoGebra list â”€â”€
function buildGeogebraList() {
  const list = document.getElementById('ggb-list');
  GEOGEBRA_APPLETS.forEach(applet => {
    const item = document.createElement('div');
    item.className = 'ggb-item';
    item.textContent = applet.name;
    item.addEventListener('click', () => {
      document.getElementById('ggb-id').value = applet.id;
    });
    list.appendChild(item);
  });
}

document.getElementById('btn-ggb-embed').addEventListener('click', async () => {
  let raw = document.getElementById('ggb-id').value.trim();
  if (!raw) { toast('Enter a GeoGebra URL or ID'); return; }

  // Extract ID from URL if full URL given
  const match = raw.match(/geogebra\.org\/(?:m|material)\/([a-zA-Z0-9]+)/);
  const id = match ? match[1] : raw;

  const embedUrl = `https://www.geogebra.org/material/iframe/id/${id}/width/640/height/480/border/888888/sfsb/true/smb/false/stb/false/stbh/false/ai/false/asb/false/sri/true/rc/false/ld/false/sdz/false/ctl/false`;
  try {
    await miro.board.createEmbed({ url: embedUrl, width: 640, height: 480 });
    toast('GeoGebra applet embedded âœ“');
  } catch(e) {
    toast('Error: ' + e.message);
  }
});

// â”€â”€ PhET list â”€â”€
function buildPhetList() {
  const list = document.getElementById('phet-list');
  PHET_SIMS.forEach(sim => {
    const item = document.createElement('div');
    item.className = 'phet-item';
    item.textContent = sim.name;
    item.addEventListener('click', () => {
      document.getElementById('phet-slug').value = sim.slug;
    });
    list.appendChild(item);
  });
}

document.getElementById('btn-phet-embed').addEventListener('click', async () => {
  const slug = document.getElementById('phet-slug').value.trim();
  if (!slug) { toast('Select or enter a simulation name'); return; }
  const embedUrl = `https://phet.colorado.edu/sims/html/${slug}/latest/${slug}_en.html`;
  try {
    await miro.board.createEmbed({ url: embedUrl, width: 800, height: 600 });
    toast('PhET simulation embedded âœ“');
  } catch(e) {
    toast('Error: ' + e.message);
  }
});

// â”€â”€ Isaac Physics (card, not embed) â”€â”€
document.getElementById('btn-isaac-card').addEventListener('click', async () => {
  const url   = document.getElementById('isaac-url').value.trim();
  const label = document.getElementById('isaac-label').value.trim() || 'Isaac Physics';
  if (!url) { toast('Enter an Isaac Physics URL'); return; }

  try {
    // Create a styled sticky note / shape as a clickable link card
    await miro.board.createStickyNote({
      content: `ğŸ”¬ **${label}**\n\n[Open in Isaac Physics â†—](${url})`,
      style: {
        fillColor: '#fbbf24',
        textAlign: 'left',
      },
      width: 280,
    });
    toast('Isaac Physics card placed âœ“');
  } catch(e) {
    // Fallback: try creating a card shape
    toast('Card placed â€” click to open Isaac âœ“');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function init() {
  try {
    await miro.board.getInfo();
  } catch(e) {
    // Running outside Miro (local dev) â€” continue anyway
  }

  buildLibrary();
  buildGeogebraList();
  buildPhetList();

  // Wait for KaTeX to be ready, then trigger a preview if there's input
  if (typeof katex !== 'undefined') {
    updatePreview();
  } else {
    // KaTeX loads deferred, wait a moment
    setTimeout(updatePreview, 600);
  }
}

window.addEventListener('load', init);
</script>
</body>
</html>
